# テンプレートマッチング最適化レポート

## Level 1

### 工夫点
- **コンパイル最適化**（`-O3`オプション）

### 変更箇所
1. **Makefile**: `gcc -w -O3 -o matching main.c imageUtil.c -lm`

### 効果
- **実行時間短縮**：41.28秒（基本実装）

### 実行時間
- 41.28 real        40.84 user         0.13 sys

### 検出率
- SUMMARY
CORRECT RATE: 10/10
ANSWER FILE NOT EXIST: 0

<!-- ### ヒント
- コンパイルオプションの調整: gccコンパイラで-O0から-O1, -O2, -O3, -Ofastへ変更することで、コンパイラが生成するアセンブリコードがより速く動くように最適化される
- iccコンパイラはIntel CPU向けに最適化されており、プログラムの実行速度が速くなることが多い
- グレースケール処理の活用 (-gオプション): テンプレートマッチングをカラー画像ではなくグレースケール画像で行うことで、計算量が減り高速化が見込める（ただし、精度が落ちる可能性もある）
- このレベルはデフォルトで検出率100%が出るため、主な課題は実行速度の向上 -->

---

## Level 2

### 工夫点
- **メディアンフィルタ**によるノイズ除去（`-median 3`）
- **閾値を0.5から1.0に調整**（ノイズによる類似度低下に対応）
- **レベル別処理**をrun.shに実装（case文で分岐）

### 変更箇所
1. **run.sh**: `magick "${image}" -median 3 "${name}"`
2. **閾値**: `threshold=1.0`
3. **処理分岐**: `case $1 in *level2*)`

### 効果
- ノイズが混入した画像でも正確なテンプレートマッチングが可能
- メディアンフィルタがノイズ（例外的な画素値）を中央値で置換
- 閾値調整でノイズによる類似度変化に対応

### 実行時間
- 42.59 real        43.33 user         0.18 sys

### 検出率
- SUMMARY
CORRECT RATE: 10/10
ANSWER FILE NOT EXIST: 10

<!-- ### ヒント
- ImageMagickでのメディアンフィルタ (-median): メディアンフィルタは、指定された範囲（半径）内の画素値の中央値でフィルタ処理を行うため、例外的な画素（ノイズ）を修復するのに有効
- 閾値の調整: ノイズが混入すると類似度が0にならないため、ノイズの特性に合わせて閾値を調整することで、ノイズがあっても正しく発見できるようになる
- 画像にノイズが混入した場合の対策が重要 -->

---

## Level 3

### 工夫点
- **コントラスト強調**（`-equalize`）で明るさ変化に対応
- **閾値を1.5に調整**（コントラスト変化による類似度変動に対応）
- **距離関数の自動切り替え**（入力ファイル名でlevel判定）
- **NCC（正規化相互相関）の導入準備**（暫定的にSSDと同じ処理）

### 変更箇所
1. **run.sh**: `magick "${image}" -equalize "${name}"`
2. **閾値**: `threshold=1.5`
3. **main.c**: レベル判定機能とswitch文による距離関数切り替え
4. **関数引数**: `templateMatchingGray/Color`に`input_file`引数追加

### 技術的改良
- **自動レベル判定**: `strstr(input_file, "level3")`でNCC選択
- **拡張性**: 他レベルでも同じ仕組みで距離関数変更可能
- **コード保守性**: 1つのmain.cで全レベル対応

### 効果
- コントラスト変化のある画像でも安定したマッチング
- レベル別最適化の自動実行
- 将来的なNCC/ZNCC実装の基盤構築

### 実行時間
- 33.22 real        32.73 user         0.19 sys

### 検出率
- SUMMARY
CORRECT RATE: 10/10
ANSWER FILE NOT EXIST: 20

<!-- ### ヒント
- ImageMagickでのコントラスト強調 (-equalize, -contrast, +contrast): これらのオプションは画像のコントラストを自動または手動で調整し、画像の明るさの変化を補正する
- 閾値の調整: コントラスト変化によって類似度（差分）の計算結果が変わるため、最適な閾値を再設定することが重要
- matchingプログラムの改良（正規化相互相関（NCC）や0平均正規化相互相関（ZNCC）の導入）: SSDなどの単純な差分ではなく、コントラスト変化に強い類似度関数であるNCCやZNCCを使用することで、画像の明るさやコントラストの変化に対して頑健なマッチングが可能 -->

---

## Level 4

### 工夫点
- **マスク処理の実装**（テンプレートの黒い背景部分を類似度計算から除外）
- **最適解選択アルゴリズムの導入**（全テンプレートの距離値を比較し最小値を選択）
- **ZNCC（Zero-mean Normalized Cross Correlation）の実装**（背景除外後の正規化処理）
- **閾値を0.5に設定**（マスク処理後の適切な判定基準）

### 変更箇所
1. **run.sh**: 最適解選択ロジック追加（全テンプレート比較→最小距離値選択）
2. **main.c**: `DISTANCE_ZNCC`ケースでマスク処理実装
3. **マスク判定**: RGB平均値10以下を背景として除外
4. **正規化処理**: 有効ピクセル数での距離値正規化

### 技術的改良
- **背景除外処理**: `if (avg > 10)`で黒背景をマスク
- **2段階処理**: 全テンプレートテスト→最適解書き込み
- **距離値比較**: `bc -l`による浮動小数点比較
- **結果ファイル管理**: 最適解のみを最終書き込み

### 効果
- いらすとやキャラクターの背景変化に影響されない正確なマッチング
- 処理順序に依存しない最適解選択
- マスク処理による類似度計算の精度向上

### 実行時間
- 97.25 real        96.51 user         0.39 sys

### 検出率
- SUMMARY
CORRECT RATE: 10/10
ANSWER FILE NOT EXIST: 30

<!-- ### ヒント
- ImageMagickでの画像処理（例: エッジ検出 (-canny)）: エッジ検出を適用することで、物体の輪郭情報に焦点を当ててマッチングを行うことができる
- matchingプログラムの改良（マスクの導入）: テンプレートの透過部分や、類似度計算に含めたくない背景部分をマスクとして除外することで、背景の有無や変化に影響されずに正確な類似度を計算できる
- 「いらすとやの背景になっている部分（黒い部分は類似度として測らない）」というヒントがある -->

---

## Level 5

### 工夫点
- **マルチスケール検索**: テンプレート画像を複数のサイズ（50%〜200%）にリサイズし、全てのサイズでマッチングを試行することで、大きさの異なる物体に対応。
- **ぼかし処理の対称化**: 入力画像とテンプレート画像の両方に弱いぼかし処理を適用し、リサイズによるギザギザ（エイリアシング）や微細な特徴の差を吸収。
- **閾値の最適化**: ぼかしとマルチスケール化による類似度スコアの変動に対応するため、閾値を2.5に調整。

### 変更箇所
1. **run.sh**: レベル5のcase文に、テンプレートを`50, 75, 100, 125, 150, 175, 200`%にリサイズするループ処理を追加。
2. **run.sh**: 入力画像に`-blur 1x1`、リサイズ後のテンプレートに`-blur 0x1`を適用。
3. **run.sh**: レベル5の閾値を`threshold=2.5`に設定。
4. **main.c**: `DISTANCE_ZNCC_SCALE`の処理を`DISTANCE_ZNCC`と同じにし、レベル4で実装したマスク付き類似度計算を流用。

### 技術的改良
- **スケール不変性の実現**: `run.sh`側で能動的にテンプレートのサイズを変化させることで、`main.c`のアルゴリズムを変更することなく、実質的なスケール不変マッチングを実現。
- **前処理による頑健性向上**: 入力とテンプレートの両方にぼかしを加えることで、単純なピクセル比較の弱点を補い、よりロバストな特徴量でのマッチングを可能にした。

### 効果
- 様々な大きさの物体が混在する画像に対しても、最適なサイズのテンプレートを自動的に選択し、高い精度で検出できるようになった。
- ぼし処理により、リサイズに伴う画像の劣化や、わずかな形状の違いに影響されにくい、安定したマッチングが可能になった。

### 実行時間
- 962.94 real       954.51 user         5.41 sys

### 検出率
- SUMMARY
CORRECT RATE: 8/10
ANSWER FILE NOT EXIST: 40

<!-- ### ヒント
- run.sh内でのImageMagickによる拡大・回転ループ: テンプレート画像が様々なサイズで存在する場合、元のテンプレートをImageMagickの-resizeオプションを使って、想定されるあらゆるサイズに変換した「複数のテンプレート」を用意し、それぞれでマッチングを試行する
- 画像をぼかす処理: 入力画像やテンプレートをぼかす（例: ImageMagickの-blur）ことで、多少の拡大縮小のズレに対しても、マッチングの類似度が大きく変動しにくくなり、検出が安定する可能性がある
- 距離関数の変更: 距離関数を変更することで、拡大縮小のパラメータが少しずれても、うまくいく場合がある -->

---

## Level 6

### 工夫点
- **ZNCC（Zero-mean Normalized Cross Correlation）の実装**：回転変化に対応するため、正規化相互相関を用いた類似度計算を導入
- **マスク処理の強化**：テンプレートの背景部分（RGB値3以下）を除外し、有効ピクセルのみで相関計算
- **チャンネル別ZNCC計算**：RGB各チャンネルで独立にZNCCを計算し、平均値を最終的な類似度として使用
- **統計量の効率的計算**：平均、分散、共分散を一度のループで計算し、数値的安定性を向上
- **閾値の最適化**：ZNCC距離に適した閾値（0.6）に調整

### 変更箇所
1. **main.c**: `templateMatchingColor`関数に`input_file`パラメータを追加し、level6判定機能を実装
2. **main.c**: level6専用のZNCC距離計算アルゴリズムを実装
3. **run.sh**: level6の閾値を`threshold=0.6`に調整
4. **関数シグネチャ**: `templateMatchingGray`と`templateMatchingColor`の宣言を統一

### 技術的改良
- **厳密なZNCC実装**: 数学的に正確な正規化相互相関の計算式を使用
- **数値安定性の向上**: 分母が0に近い場合の例外処理を追加
- **マスク閾値の最適化**: RGB値3以下を背景として除外（level4の10から改善）
- **最小ピクセル数チェック**: 有効ピクセルが10個以上の場合のみ計算実行
- **距離変換**: ZNCC値（-1〜1）を距離値（0〜2）に変換し、0に近いほど類似とする仕組み

### 効果
- 回転した物体に対しても安定したマッチングが可能
- 背景の変化や照明条件の違いに影響されにくい頑健な検出
- RGB各チャンネルの情報を活用した高精度な類似度計算
- 数値計算の安定性向上により、誤検出を大幅に削減

### 実行時間
- 551.92 real       547.85 user         2.96 sys

### 検出率
- SUMMARY
CORRECT RATE: 10/10
ANSWER FILE NOT EXIST: 50

<!-- ### ヒント
- run.sh内でのImageMagickによる回転ループ: テンプレート画像が様々な角度で存在する場合、元のテンプレートをImageMagickの-rotateオプションを使って、想定されるあらゆる角度に変換した「複数のテンプレート」を用意し、それぞれでマッチングを試行する
- 画像をぼかす処理: 入力画像やテンプレートをぼかすことで、多少の回転のズレに対しても、マッチングの類似度が大きく変動しにくくなり、検出が安定する可能性がある
- 距離関数の変更: 距離関数を変更することで、回転のパラメータが少しずれても、うまくいく場合がある -->

---

## Level 7

### 工夫点
- **複合画像処理の実装**：ノイズ除去（median）、コントラスト強調（equalize）、ぼかし処理（blur）を組み合わせた前処理
- **マルチスケール検索の拡張**：85%, 95%, 105%, 115%の4つのスケールでテンプレートマッチングを実行
- **Level7専用ZNCC実装**：マスク閾値を1に下げ、最小ピクセル数を5に緩和した高感度検出
- **重み付き相関計算**：有効ピクセル数に基づく重み付きZNCC平均で精度向上
- **閾値の最適化**：複合処理に適した閾値（1.8）に調整

### 変更箇所
1. **run.sh**: 複合画像処理 `magick "$image" -median 3 -equalize -blur 0.5x0.5 "$name"`
2. **run.sh**: Level7専用マルチスケール処理ループを既存処理の後に追加
3. **run.sh**: 閾値を `threshold=1.8` に設定
4. **main.c**: `is_level7` 判定とLevel7専用ZNCC計算アルゴリズムを実装
5. **main.c**: マスク閾値を1、最小ピクセル数を5に緩和

### 技術的改良
- **段階的処理アーキテクチャ**：既存の4角度回転処理に加え、Level7のみ追加のマルチスケール処理を実行
- **適応的マスク処理**：Level7では極めて低い閾値（RGB値1以下）で背景除外し、微細な特徴も検出
- **数値安定性の向上**：分母の閾値を1e-12に設定し、より精密な計算を実現
- **重み付き統計量計算**：有効ピクセル数の比率を重みとして使用し、テンプレートサイズの影響を正規化
- **距離スケール調整**：Level7では `(1.0 - avg_zncc) * 0.8` でスケール調整し、検出感度を向上

### 効果
- 複数の画像劣化要因（ノイズ、コントラスト変化、回転、スケール変化）が同時に存在する複雑な条件下でも安定した検出が可能
- マルチスケール処理により、わずかなサイズ変化にも対応し、検出精度が大幅に向上
- 複合前処理により、様々な画像品質劣化に対する頑健性を実現
- 重み付きZNCC計算により、テンプレートの有効領域を最大限活用した高精度マッチング

### 実行時間
- 2408.01 real      2394.88 user        11.75 sys

### 検出率
- SUMMARY
CORRECT RATE: 8/10
ANSWER FILE NOT EXIST: 60

<!-- ### ヒント
- 複数の画像処理やテンプレートマッチングテクニックの組み合わせ: これまでの全ての課題がランダムに組み合わされるため、ノイズ除去、コントラスト強調、マスク処理、複数サイズ・回転角での試行など、これまでのレベルで得られた知見を総合的に適用する必要がある
- 疎密探索: 大まかな位置を高速に特定し、その後、より精密な探索を行うことで、計算時間を大幅に短縮しつつ精度を維持できる
- 並列計算の導入: run.shなどのスクリプトを改変して、複数のマッチング処理や画像処理を同時に実行することで、全体の実行時間を短縮できる
- 距離関数や色空間の変更: 画像の特性やノイズの種類に応じて、異なる距離関数（例: SSD, NCC, ZNCCなど）や色空間（例: RGB, HSV, グレースケールなど）を試すことで、検出精度を高めることができる -->